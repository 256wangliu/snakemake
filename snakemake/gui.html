<html>
    <head>
        <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.6/d3.min.js"></script>
        <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://raw.githubusercontent.com/d3/d3-plugins/master/sankey/sankey.js"></script>
        <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css"/>
        <style>
        body {
          font-family: sans-serif;
          font-size: 10pt;
          padding-top: 70px;
        }
        svg#dag {
            width: 100%;
            height: 500px;
        }
        #workflow-progress {
            width: 100%;
        }
        #workflow-progress #progress-text {
            width: 0%;
            transition: width 2s;
            min-width: 13em;
            text-align: right;
            color: #CCCCCC;
        }
        #workflow-progress #progress-bar {
            width: 0%;
            transition: width 2s;
            height: 0.5em;
            background-color: #CCCCCC;
        }
        
        #left-panel {
            float: left;
            width: 50%;
        }
        
        #left-panel #control {
            padding: 5px;
        }
        
        #log {
            width: 50%;
            float: right;
        }
        
        #log table {
            font-size: 10pt;
            margin: 0;
        }
        
        #log div {
             overflow: auto;
             padding: 5px;
        }
        
        #log .info {
            background-color: #f1c40f;
        }
        
        #log .error {
            background-color: #e74c3c;
        }
        
        #log .job_info {
            background-color: #2ecc71;
        }
        
        th.ruleitem {
            width: 10em;
        }
        
        .node rect {
          cursor: move;
          fill-opacity: .9;
          shape-rendering: crispEdges;
        }
        .node text {
          pointer-events: none;
        }
        .link {
          fill: none;
          stroke: #000;
          stroke-opacity: .2;
        }
        .link:hover {
          stroke-opacity: .5;
        }
        </style>
        <script>
        function render_dag() {
            d3.json("dag", function(dag) {
                var svg = d3.select("#dag");
                svg.select("g").remove();
                var view = svg.append("g").attr("transform", "translate(40,0)");

                var dag_width = parseInt(svg.style("width")) - 10;
                var dag_height = parseInt(svg.style("height")) - 10;

                var layout = d3.sankey()
                    .size([dag_width - 50, dag_height])
                    .nodeWidth({{node_width}})
                    .nodePadding({{node_padding}})
                    .nodes(dag.nodes)
                    .links(dag.links)
                    .layout(32)

                var color = d3.scale.category20();

                var path = layout.link();
                
                var link = view.append("g").selectAll(".link")
                        .data(dag.links)
                    .enter().append("path")
                        .attr("class", "link")
                        .attr("d", path)
                        .style("stroke-width", function(d) { return Math.max(1, d.dy); })
                        .sort(function(a, b) { return b.dy - a.dy; });
                
                link.append("title")
                    .text(function(d) { return d.source.name + " â†’ " + d.target.name + "\n" + d.value; });

                var node = view.append("g").selectAll(".node")
                        .data(dag.nodes)
                    .enter().append("g")
                        .attr("class", "node")
                        .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
                    .call(d3.behavior.drag()
                        .origin(function(d) { return d; })
                        .on("dragstart", function() { this.parentNode.appendChild(this); })
                        .on("drag", dragmove));

                node.append("rect")
                        .attr("height", function(d) { return d.dy; })
                        .attr("width", layout.nodeWidth())
                        .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
                        .style("stroke", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
                    .append("title")
                        .text(function(d) { return d.name + "\n" + d.value; });

                node.append("text")
                        .attr("x", -6)
                        .attr("y", function(d) { return d.dy / 2; })
                        .attr("dy", ".35em")
                        .attr("text-anchor", "end")
                        .attr("transform", null)
                        .text(function(d) { return d.name; })
                    .filter(function(d) { return d.x < dag_width / 2; })
                        .attr("x", 6 + layout.nodeWidth())
                        .attr("text-anchor", "start");

                function dragmove(d) {
                    d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(dag_height - d.dy, d3.event.y))) + ")");
                    layout.relayout();
                    link.attr("d", path);
                }
            });
        }

        var logid = 0;
        function update() {
            d3.json("progress", function(progress) {
                var done = progress.done;
                if(done) {
                    var total = progress.total;
                    var percent = done / total * 100;
                    $("#workflow-progress").removeClass("invisible")
                    $("#workflow-progress #progress-bar")
                        .css("width", percent + "%");
                    $("#workflow-progress #progress-text")
                        .css("width", percent + "%")
                        .text(done + " of " + total + " jobs finished (" + percent + "%)");
                }
            });
            
            $.getJSON("log/" + logid, function(entries) {
                console.log(entries);
                $.each(entries, function(i, entry) {
                    if(entry.level == "job_info") {
                        var html = '<div class="job_info"><h4>'
                        + entry.name + '</h4><table>';
                        $.each(["input", "output"], function(i, item) {
                            if(entry[item].length) {
                                html += '<tr><th class="ruleitem">' + item + '</th><td>' + entry[item].join(", ") + '</td></tr>';
                            }
                        });
                        $.each(["threads", "priority"], function(item) {
                            if(entry[item] > 1) {
                                html += '<tr><th class="ruleitem">' + item + '</th><td>' + entry[item] + '</td></tr>';
                            }
                        });
                        html += '</table></div>';
                        $(html).appendTo($("#log"));
                    }
                    else {
                        var type = "info"
                        switch(entry.level) {
                            case "info":
                                type="warning";
                                break;
                            case "error":
                                type="danger";
                                break;
                        }
                        $("#log").append(
                            '<div class="' + entry.level + '">'
                            + entry.msg +
                            '</div>'
                        );
                    }
                    logid++;
                });
            });
        }
        $( document ).ready(function() {
            $("#run-btn").click(function() {
                $.ajax("run");
                console.log("done");
                $("#run-btn").prop("disabled",true);
                update();
                setInterval(update, 2000);
            });
            
            render_dag();
            d3.select(window).on('resize', render_dag);
        });
        </script>
    </head>
    <body>
        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="navbar-header"><p class="navbar-brand">Snakemake Workflow</p></div>
        </nav>
        <svg id="dag">
        </svg>
        <div id="workflow-progress" class="invisible">
            <div id="progress-bar">
            </div>
            <div id="progress-text">
            </div>
        </div>
        <div id="left-panel">
            <form id="control">
            <button type="button" id="run-btn" class="btn btn-default navbar-btn">Run</button>
            </form>
        </div>
        <div id="log">
        </div>
    </body>
</html>
